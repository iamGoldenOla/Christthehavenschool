name: Deploy to cPanel via FTP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build application
      run: npm run build
    
    - name: List dist contents
      run: |
        echo "===== DIST FOLDER ====="
        ls -laR dist/
        echo ""
        echo "===== SIZE ====="
        du -sh dist/
    
    - name: Debug FTP credentials
      run: |
        echo "FTP_HOST: ${{ secrets.FTP_HOST }}"
        echo "FTP_USERNAME: ${{ secrets.FTP_USERNAME }}"
        echo "FTP_PORT: ${{ secrets.FTP_PORT }}"
        echo "FTP_DIR: ${{ secrets.FTP_DIR }}"
        echo "Note: Password is hidden for security"
    
    - name: Install lftp
      run: sudo apt-get update && sudo apt-get install -y lftp
    
    - name: Deploy files via FTP
      run: |
        echo "Starting FTP deployment..."
        lftp -e "
        set ftp:ssl-allow no
        set net:max-retries 2
        set net:timeout 10
        open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_HOST }}:${{ secrets.FTP_PORT }}
        cd ${{ secrets.FTP_DIR }}
        mirror -R --delete ./dist/ ./
        bye
        " 2>&1
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ FTP deployment successful!"
        else
          echo "‚ùå FTP deployment failed! Check credentials and server."
          exit 1
        fi
    
    - name: Deployment Summary
      run: |
        echo "=========================================="
        echo "‚úÖ Deployment Complete!"
        echo "=========================================="
        echo ""
        echo "Server: ${{ secrets.FTP_HOST }}"
        echo "Port: ${{ secrets.FTP_PORT }}"
        echo "Path: ${{ secrets.FTP_DIR }}"
        echo ""
        echo "üåê Visit: https://christthehavenschool.com"
        echo ""
        echo "If site doesn't load:"
        echo "1. Wait 2-5 minutes for server propagation"
        echo "2. Clear browser cache (Ctrl+Shift+Delete)"
        echo "3. Hard refresh (Ctrl+F5)"
        echo "=========================================="
